{{- $namespace := include "mip.namespace" . -}}
{{- $platformBackend := index .Values "platform-backend" -}}
{{- $localStorageClass := .Values.cluster.storageClasses.local -}}
{{- $managedStorageClass := .Values.cluster.storageClasses.managed -}}
{{- if not .Values.cluster.managed }}
---
# 1) platform-backend DB data on hostPath
apiVersion: v1
kind: PersistentVolume
metadata:
  name: platform-backend-db-vol0
  labels:
    storage: platform-backend-db-storage0
spec:
  capacity:
    storage: {{ .Values.platformBackendDatabase.persistence.size }}
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete
  storageClassName: {{ $localStorageClass }}
  hostPath:
    path: {{ .Values.platformBackendDatabase.persistence.localPath }}
    type: DirectoryOrCreate
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: master
              operator: In
              values:
                - "true"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: platform-backend-db-claim0
  namespace: {{ $namespace }}
  labels:
    storage: platform-backend-db-storage0
spec:
  selector:
    matchLabels:
      storage: platform-backend-db-storage0
  storageClassName: {{ $localStorageClass }}
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.platformBackendDatabase.persistence.size }}

---
# 2) platform-backend config/storage on hostPath
apiVersion: v1
kind: PersistentVolume
metadata:
  name: platform-backend-storage-vol0
  labels:
    storage: platform-backend-storage0
spec:
  capacity:
    storage: {{ $platformBackend.persistence.data.size }}
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete
  storageClassName: {{ $localStorageClass }}
  hostPath:
    path: {{ $platformBackend.persistence.data.localPath }}
    type: DirectoryOrCreate
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: master
              operator: In
              values:
                - "true"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: platform-backend-claim0
  namespace: {{ $namespace }}
  labels:
    storage: platform-backend-storage0
spec:
  selector:
    matchLabels:
      storage: platform-backend-storage0
  storageClassName: {{ $localStorageClass }}
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ $platformBackend.persistence.data.size }}

---
# 3) platform-backend logs on hostPath
apiVersion: v1
kind: PersistentVolume
metadata:
  name: platform-backend-logs-vol0
  labels:
    storage: platform-backend-logs-storage0
spec:
  capacity:
    storage: {{ $platformBackend.persistence.logs.size }}
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: {{ $localStorageClass }}
  hostPath:
    path: {{ $platformBackend.persistence.logs.localPath }}
    type: DirectoryOrCreate
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: master
              operator: In
              values:
                - "true"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: platform-backend-logs-claim0
  namespace: {{ $namespace }}
  labels:
    storage: platform-backend-logs-storage0
spec:
  selector:
    matchLabels:
      storage: platform-backend-logs-storage0
  storageClassName: {{ $localStorageClass }}
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ $platformBackend.persistence.logs.size }}
{{- else }}
---
# managed cluster: only dynamic PVCs on CephFS
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: platform-backend-db-claim0
  namespace: {{ $namespace }}
  annotations:
    # tells Argo CD: do not prune (delete) this resource
    argocd.argoproj.io/sync-options: Delete=false,Prune=false
spec:
  storageClassName: {{ $managedStorageClass }}
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ .Values.platformBackendDatabase.persistence.size }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: platform-backend-claim0
  namespace: {{ $namespace }}
  annotations:
    # tells Argo CD: do not prune (delete) this resource
    argocd.argoproj.io/sync-options: Delete=false,Prune=false
spec:
  storageClassName: {{ $managedStorageClass }}
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ $platformBackend.persistence.data.size }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: platform-backend-logs-claim0
  namespace: {{ $namespace }}
  annotations:
    # tells Argo CD: do not prune (delete) this resource
    argocd.argoproj.io/sync-options: Delete=false,Prune=false
spec:
  storageClassName: {{ $managedStorageClass }}
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ $platformBackend.persistence.logs.size }}
{{- end }}

---

apiVersion: v1
kind: ConfigMap
metadata:
  name: platform-backend-db-init
  namespace: {{ $namespace }}
data:
  10-bootstrap-platform-db.sh: |
{{ .Files.Get "files/platform-backend-db-init.sh" | nindent 4 }}

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: platform-backend
  namespace: {{ $namespace }}
  labels:
    app: platform-backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: platform-backend
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: platform-backend
    spec:
{{- if not .Values.cluster.managed }}
      nodeSelector:
        master: "true"
{{- end }}
      hostname: platform-backend
      volumes:
        - name: platform-backend-db-claim0
          persistentVolumeClaim:
            claimName: platform-backend-db-claim0
        - name: platform-backend-claim0
          persistentVolumeClaim:
            claimName: platform-backend-claim0
        - name: platform-backend-logs-claim0
          persistentVolumeClaim:
            claimName: platform-backend-logs-claim0
        - name: platform-backend-db-init
          configMap:
            name: platform-backend-db-init
            defaultMode: 0755
      containers:
        - name: platform-backend-db
          image: {{ .Values.platformBackendDatabase.image.repository }}:{{ .Values.platformBackendDatabase.image.tag }}
          ports:
            - containerPort: 5432
          volumeMounts:
            - name: platform-backend-db-claim0
              mountPath: /var/lib/postgresql/data
            - name: platform-backend-db-init
              mountPath: /opt/platform-backend-db-init
              readOnly: true
          args:
            - -p
            - "5432"
          env:
            - name: POSTGRES_DB
              value: postgres
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: mip-secret
                  key: platform-backend-db.DB_ADMIN_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mip-secret
                  key: platform-backend-db.DB_ADMIN_PASSWORD
            - name: PLATFORM_DB_NAME
              value: portal
            - name: PLATFORM_DB_USER
              valueFrom:
                secretKeyRef:
                  name: mip-secret
                  key: platform-backend-db.PLATFORM_DB_USER
            - name: PLATFORM_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mip-secret
                  key: platform-backend-db.PLATFORM_DB_PASSWORD
          lifecycle:
            postStart:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - /opt/platform-backend-db-init/10-bootstrap-platform-db.sh

        - name: platform-backend
          image: {{ $platformBackend.image.repository }}:{{ $platformBackend.image.tag }}
          ports:
            - containerPort: 8080
            - containerPort: 8089
          volumeMounts:
            - name: platform-backend-claim0
              mountPath: /opt/platform/api
            - name: platform-backend-logs-claim0
              mountPath: /var/log/platform-backend
          env:
            - name: LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: mip-config
                  key: platform-backend.LOG_LEVEL
            - name: LOG_LEVEL_FRAMEWORK
              valueFrom:
                configMapKeyRef:
                  name: mip-config
                  key: platform-backend.LOG_LEVEL_FRAMEWORK
            - name: AUTHENTICATION
              valueFrom:
                configMapKeyRef:
                  name: mip-config
                  key: keycloak.AUTHENTICATION
            - name: PLATFORM_DB_URL
              value: jdbc:postgresql://localhost:5432/portal
            - name: PLATFORM_DB_SERVER
              value: localhost:5432
            - name: PLATFORM_DB_USER
              valueFrom:
                secretKeyRef:
                  name: mip-secret
                  key: platform-backend-db.PLATFORM_DB_USER
            - name: PLATFORM_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mip-secret
                  key: platform-backend-db.PLATFORM_DB_PASSWORD
            - name: EXAFLOW_URL
              valueFrom:
                configMapKeyRef:
                  name: mip-config
                  key: engines.exaflow.URL
            - name: PLATFORM_UI_BASE_URL
              valueFrom:
                configMapKeyRef:
                  name: mip-config
                  key: mip.PLATFORM_UI_URL
            - name: KEYCLOAK_AUTH_URL
              valueFrom:
                configMapKeyRef:
                  name: mip-config
                  key: keycloak.AUTH_URL
            - name: KEYCLOAK_REALM
              valueFrom:
                configMapKeyRef:
                  name: mip-config
                  key: keycloak.REALM
            - name: KEYCLOAK_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: keycloak-credentials
                  key: client-id
            - name: KEYCLOAK_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: keycloak-credentials
                  key: client-secret
            # - name: KEYCLOAK_SSL_REQUIRED
            #   valueFrom:
            #     configMapKeyRef:
            #       name: mip-config
            #       key: keycloak.SSL_REQUIRED
            - name: ALGORITHM_UPDATE_INTERVAL
              valueFrom:
                configMapKeyRef:
                  name: mip-config
                  key: platform-backend.ALGORITHM_UPDATE_INTERVAL

---
apiVersion: v1
kind: Service
metadata:
  name: platform-backend-service
  namespace: {{ $namespace }}
  labels:
    app: platform-backend
spec:
  selector:
    app: platform-backend
  ports:
    - name: "5432"
      port: 5432
      targetPort: 5432
    - name: "8080"
      port: 8080
      targetPort: 8080
